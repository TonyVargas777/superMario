<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" />
    <meta content="width=device-width" />
    <meta content="initial-scale=0.8" />
    <title>Mario</title>
    <style>
      body {
        background-color: #000000;
        text-align: center;
      }
      canvas {
        width: 448px;
        height: 400px;
        border: 4px solid blue;        
        background-image: url(./fondo_vacio.png);
        background-size: 448px 400px;
      }
      #logo_mario {
        margin: auto;
        display: inline;
        vertical-align: top;
      }
      .pantalla {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <div class="pantalla">
      <img
        id="logo_mario"
        src="./Super_Mario_Bros._Logo.svg.png"
        width="452px"
        alt="logo_mario"
      />
      <canvas></canvas>
      <img hidden id="sprite_doble" src="./sprite_doble.png" alt="sprite Doble Mario" />
      <img id="sprite_doble" src="./controler.jpg" alt="sprite Doble Mario" width="452px"/>
    </div>


    <script>
      const canvas = document.querySelector("canvas");
      const ctx = canvas.getContext("2d");
      const $sprite_doble = document.getElementById("sprite_doble");

                  // =================== //
                  // VARIABLES DEL JUEGO //
                  // =================== //

      //Tamaño de Mario
      const marioWidth = 16;
      const marioHeight = 32;

      //Posición inicial Mario
      let marioX = (canvas.width - marioWidth) / 2;
      let marioY = canvas.height - marioHeight - 38;

      //Cursores
      let rightPressed = false;
      let leftPressed = false;
      let upPressed = false;
      let downPressed = false;

      // Imágenes para la animación de Mario
      const marioImagesRight = [
        { x: 0, y: 32 }, // Mario quieto
        { x: 96, y: 32 }, // Mario caminando 1
        { x: 64, y: 32 }, // Mario caminando 2
        { x: 32, y: 32 }, // Mario caminando 3
      ];
      const marioImagesLeft = [
        { x: 400, y: 32 }, // Mario quieto
        { x: 304, y: 32 }, // Mario caminando 1
        { x: 336, y: 32 }, // Mario caminando 2
        { x: 368, y: 32 }, // Mario caminando 3
      ];   
      
      const marioImageJumpRight = { x: 192, y: 32 }; // Imagen de Mario saltando derecha
      const marioImageJumpLeft = { x: 208, y: 32 }; // Imagen de Mario saltando izq
      const marioImageCrouchRight = { x: 160, y: 32 }; // Imagen de Mario agachado derecha
      const marioImageCrouchLeft = { x: 240, y: 32 }; // Imagen de Mario agachado izq

      let currentFrame = 0; // Índice de la imagen actual de Mario
      let animationFrame = 0; // Contador para la animación
      let marioDirection = "right"; // Dirección inicial de Mario
      
              // =================== //
              // FUNCIONES DEL JUEGO //
              // =================== //

      function drawMario() {
        ctx.beginPath();
        const marioImages = marioDirection === "right" ? marioImagesRight : marioImagesLeft;
        const { x, y } = marioImages[currentFrame];
        ctx.drawImage(
          $sprite_doble,  //imagen
          x,              //coordenada x donde empieza a recortar
          y,              //coordenada y donde empieza a recortar
          16,             //tamaño del recorte a lo ancho
          32,             //tamaño del recorte a lo alto
          marioX,         //posicion de la imagen en el canvas en X
          marioY,         //posicion de la imagen en el canvas en Y
          16,             //ancho del dibujo en el canvas
          32              //alto del dibujo en el canvas
          );
        ctx.closePath();
      }

      function updateMarioFrame() {
        animationFrame++;
        if (animationFrame % 5 === 0) {
          currentFrame = (currentFrame + 1) % marioImagesRight.length;
        }
        if (!leftPressed && !rightPressed) {
          currentFrame = 0; // Vuelve a la imagen inicial si no se está pulsando ninguna tecla
        }
      }

      function marioMovement() {
        if (rightPressed && marioX < canvas.width - marioWidth) {
          marioDirection = "right";
          marioX += 1;          
        } else if (leftPressed && marioX > 0) {
          marioDirection = "left";
          marioX -= 1;
        }
        //xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
        if (upPressed && marioDirection === "right") {
          // Salto de Mario a la derecha
          marioDirection = "right";
          ctx.clearRect(marioX, marioY, marioWidth, marioHeight);
          const { x, y } = marioImageJumpRight;
          ctx.drawImage($sprite_doble, x, y, marioWidth, marioHeight, marioX, marioY -10, marioWidth, marioHeight);
        } else if (upPressed && marioDirection === "left") {
          // Salto de Mario a la izquierda
          marioDirection = "left";
          ctx.clearRect(marioX, marioY, marioWidth, marioHeight);
          const { x, y } = marioImageJumpLeft;
          ctx.drawImage($sprite_doble, x, y, marioWidth, marioHeight, marioX, marioY -10, marioWidth, marioHeight);
        }
        if (downPressed && marioDirection === "right") {
          // Agachada de Mario a la derecha
          marioDirection = "right";
          ctx.clearRect(marioX, marioY, marioWidth, marioHeight);
          const { x, y } = marioImageCrouchRight;
          ctx.drawImage($sprite_doble, x, y, marioWidth, marioHeight, marioX, marioY + 3, marioWidth, marioHeight - 3);
        } else if (downPressed && marioDirection === "left") {
          // Agachada de Mario a la izquierda
          marioDirection = "left";
          ctx.clearRect(marioX, marioY, marioWidth, marioHeight);
          const { x, y } = marioImageCrouchLeft;
          ctx.drawImage($sprite_doble, x, y, marioWidth, marioHeight, marioX, marioY + 3, marioWidth, marioHeight - 3);
        }
      }             

      function cleanCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }

                //====================//
                //FUNCIONES DE EVENTOS//
                //====================//

      function initEvents() {
        document.addEventListener("keydown", keyDownHandler);
        document.addEventListener("keyup", keyUpHandler);
        canvas.addEventListener("touchstart", touchStartHandler);
        canvas.addEventListener("touchmove", touchMoveHandler);
        canvas.addEventListener("touchend", touchEndHandler);

        function keyDownHandler(event) {
          const { key } = event;
          if (key === "ArrowRight") {
            rightPressed = true;
          }
          if (key === "ArrowLeft") {
            leftPressed = true;
          }
          if (key === "ArrowUp") {
            upPressed = true;
          }
          if (key === "ArrowDown") {
            downPressed = true;
          }
        }

        function keyUpHandler(event) {
          const { key } = event;
          if (key === "ArrowRight") {
            rightPressed = false;
          }
          if (key === "ArrowLeft") {
            leftPressed = false;
          }
          if (key === "ArrowUp") {
            upPressed = false;
          }
          if (key === "ArrowDown") {
            downPressed = false;
          }
        }
      }

      function touchStartHandler(event) {
          const touchX = event.touches[0].clientX;
          if (touchX < canvas.width / 2 && canvas.height >100 && canvas.height< 300) {
            leftPressed = true;
          } else {
            rightPressed = true;
          }
        }

        function touchMoveHandler(event) {
          event.preventDefault(); // Prevent scrolling on touch devices
          const touchX = event.touches[0].clientX;
          if (touchX < canvas.width / 2 && canvas.height >100 && canvas.height< 300) {
            leftPressed = true;
            rightPressed = false; // Aseguramos que solo una dirección esté activa
          } else if (touchX < canvas.width / 2 && canvas.height >100 && canvas.height< 300) {
            leftPressed = false; // Aseguramos que solo una dirección esté activa
            rightPressed = true;
          }
        }

        function touchEndHandler(event) {
          leftPressed = false;
          rightPressed = false;
        }
      


      function draw() {
        console.log({leftPressed, rightPressed, upPressed, downPressed});
        cleanCanvas();
        drawMario();
        marioMovement();
        updateMarioFrame();
        window.requestAnimationFrame(draw);
      }
      draw();
      initEvents();
    </script>
  </body>
</html>
